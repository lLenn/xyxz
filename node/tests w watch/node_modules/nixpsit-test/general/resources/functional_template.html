<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script>
		var calls = {};
	    var call_executions = {};
    
	    function getCall(notation) {
	    	var names = notation.split(".");
	    	var call = window;
	    	var parent;
	    	for(var i = 0, len = names.length; i < len; i++) {
	    		if(call[names[i]] === undefined) {
	    			call[names[i]] = function(){};
	    		}
	    		parent = call;
	    		call = call[names[i]];
	    	}
	    	return { parent: parent, call: call, names: names };
	    }
	
	    function mockCall(notation, name, response) {
	    	var call = getCall(notation);
	    	var callName = call.names[call.names.length - 1];
	    	calls[name] = call.parent[callName];
	    	call.parent[callName] = function() {
	    		var args = _stripCallbackFunctions(arguments);
	    		call_executions[name].push({ args: args });
	    		if(response === undefined) {
	    			if(call.names[0] === "api_async") {
	    				var call_sync = getCall(notation.replace("api_async", "api_sync"));
	    				_getCallbackFunction(arguments, "result")(call_sync.parent[callName].apply(call_sync.parent, args));
	    			} else {
		    			return calls[name].apply(call.parent, arguments);
	    			}
	    		} else if(response !== null) {
	    			if(call.names[0] === "api_async") {
	    				_getCallbackFunction(arguments, "result")(response);
	    			} else {
	    				return response;
	    			}
	    		}
	    	};
	    	call_executions[name] = [];
	    }
	
	    function undoMock(notation, name) {
	    	var call = getCall(notation);
	    	var callName = call.names[call.names.length - 1];
	    	call.parent[callName] = calls[name];
	    }
	    
	    function _getCallbackFunction(args, name) {
			if(name === "result" && typeof args[args.length-2] === "function") {
				return args[args.length-2];
			} else if((name === "result" && typeof args[args.length-2] !== "function" && typeof args[args.length-1] === "function") ||
					(name === "error" && typeof args[args.length-2] === "function" && typeof args[args.length-1] === "function")) {
				return args[args.length-1];
			} else if(name === "error") {
				return function(pError) { console.log(pError); };
			} else {
				throw new Error("Async api call's arguments doesn't include a function for the results!");
			} 
		}

		function _stripCallbackFunctions(args) {
			if(typeof args[args.length-2] === "function") {
				return Array.prototype.slice.call(args, 0, -2);
			} else if(typeof args[args.length-1] === "function") {
				return Array.prototype.slice.call(args, 0, -1);
			} else {
				return args;
			}
		}
		
		function _replaceCallbackFunction(args, name, replaceFnc) {
			if(name === "result" && typeof args[args.length-2] === "function") {
				args[args.length-2] = replaceFnc;
			} else if((name === "result" && typeof args[args.length-2] !== "function" && typeof args[args.length-1] === "function") ||
					(name === "error" && typeof args[args.length-2] === "function" && typeof args[args.length-1] === "function")) {
				args[args.length-1] = replaceFnc;
			} else if(name === "result") {
				throw new Error("Async api call's arguments doesn't include a function for the results!");
			} 
			return args;
		}
    </script>
</head>
<body style="position: absolute; top: 0; bottom: 0; left: 0; right: 0;">
    <div id="tests_container"></div>
</body>
</html>